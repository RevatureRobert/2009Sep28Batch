<!DOCTYPE html>
<!-- Author: Nicolas Hernandez -->

<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
            crossorigin="anonymous"
        />
        <style>
            .game-map-tile{
                margin: 5px;
                height: 100px;
                /*
                background-color: lightsalmon;
                */
            }

            .player{
                background-color: blue;
            }

            .unexplored{
                background-color: #333333;
            }

            .explored{
                background-color: #bbbbbb;
            }

            .monster{
                background-color: green;
            }

            .wide-upper-margin{
                margin-top: 30px;
            }
        </style>

        <title>DOM DebugMe</title>
    </head>
    <body>
        <div class="container">
            <div class="row justify-content-center wide-upper-margin move-buttons">
                <button onclick="moveUp(event)">UP</button>
                <button onClick="moveDown(event)">DOWN</button>
                <button onclick="moveLeft(event)">LEFT</button>
                <button onClick="moveRight(event)">RIGHT</button>
            </div>
            <div class="row justify-content-center wide-upper-margin">
                <button onclick="attack(event)">ATTACK</button>
                <button onClick="heal(event)">HEAL</button>
            </div>

            <div class="row justify-content-center wide-upper-margin">
                <button onclick="reset()">RESET</button>
            </div>

            <div class="row justify-content-center wide-upper-margin">
                <p id="sword-display"></p>
            </div>
        </div>
            
    <script>
        let score = 30;
        let enemies = 4;
        let isDead = false;
        let inBattle = false;
        
        // 0 for player, 1 for unexplored, 2 for explored, 3 for enemy, 4 for sword
        const boardTemplate = [
            [1, 1, 3, 1, 1],
            [1, 1, 1, 1, 1],
            [3, 1, 0, 1, 3],
            [1, 1, 1, 1, 1],
            [1, 1, 3, 1, 1],
        ];
        // currentBoard is now a copy of the boardTemplate
        let currentBoard = JSON.parse(JSON.stringify(boardTemplate));
        let position = [2, 2];
        let swordPosition = [5, 5];

        const player = {
            name: 'player',
            health: 30.0,
            damage: 1.0
        }
        const enemy = {
            name: 'goblin',
            health: 20.0,
            damage: 3.0
        }

        // Create an initial map based on the input board
        // ONLY USED TO CREATE NEW BOARDS; THIS WILL THROW OUT THE OLD BOARD
        function createNewMap(board){
            // toss the old game out and make a new one!
            const oldGame = document.getElementById('map-container');
            if(oldGame != null){
                oldGame.textContent = '';
                oldGame.remove();
            }
            currentBoard = JSON.parse(JSON.stringify(board));
            enemies = 4;
            player.damage = 1.0;
            player.health = 30.0;
            score = 30;

            const newGame = document.createElement('div');
            newGame.className = 'container';
            newGame.id = 'map-container';
            
            // construct the row
            for(let yIndex = 0; yIndex < board.length; yIndex++){
                const row = document.createElement('div');
                row.className = 'row';

                // construct the tile
                for(let xIndex = 0; xIndex < board[yIndex].length; xIndex++){
                    const tile = document.createElement('div');
                    tile.className = 'col game-map-tile';
                    tile.id = 'x' + xIndex + 'y' + yIndex;

                    switch(board[yIndex][xIndex]){
                        case 0:
                            tile.className = tile.className + ' player';
                            position = [yIndex, xIndex];
                            break;
                        case 1:
                            tile.className = tile.className + ' unexplored';
                            break;
                        case 2:
                            tile.className = tile.className + ' explored';
                            break;
                        case 3:
                          tile.className = tile.className + ' monster';
                    }

                    //tile.innerHTML = tile.className;
                    // add the tile to the row
                    row.appendChild(tile);
                }

                // add the row to the game
                newGame.appendChild(row);
            }

            // place the sword
            swordPosition = [Math.round(Math.random() * 4), Math.round(Math.random() * 4)];
            if(position[0] === swordPosition[0] && position[1] === swordPosition[1])
                player.damage = 5.0;

            document.getElementsByTagName('body')[0].prepend(newGame);
        }// Map created!

        createNewMap(boardTemplate);

        // Updates the rendered map according to the input board
        function updateMapUsingBoard(board){
            for(let yIndex = 0; yIndex < board.length; yIndex++){
                for(let xIndex = 0; xIndex < board[yIndex].length; xIndex++){
                    
                    const tile = document.getElementById('x' + xIndex + 'y' + yIndex);
                    
                    tile.className = 'col game-map-tile';
                    switch(board[yIndex][xIndex]){
                        case 0:
                            tile.className = tile.className + ' player';
                            break;
                        case 1:
                            tile.className = tile.className + ' unexplored';
                            break;
                        case 2:
                            tile.className = tile.className + ' explored';
                            break;
                        case 3:
                            tile.className = tile.className + ' monster';
                    }
                    // tile.innerHTML = tile.className;
                }
            }
        }// Map updated!

        function moveUp(){
            if(!isDead && position[0] > 0){
                currentBoard[position[0]][position[1]] = 2;
                position[0]--;
                if(position[0] === swordPosition[0] && position[1] === swordPosition[1]){
                    player.damage = 5.0;
                    swordPosition = [5, 5];
                    document.getElementById("sword-display").textContent = "You've got the sword!";
                }
                if(currentBoard[position[0]][position[1]] === 3)
                    fightMonster();

                currentBoard[position[0]][position[1]] = 0;

                score--;

                updateMapUsingBoard(currentBoard);
            }
        }
        function moveDown(){
            if(!isDead && position[0] < 4){
                currentBoard[position[0]][position[1]] = 2;
                position[0]++;
                if(position[0] === swordPosition[0] && position[1] === swordPosition[1]){
                    player.damage = 5.0;
                    swordPosition = [5, 5];
                    document.getElementById("sword-display").textContent = "You've got the sword!";
                }
                if(currentBoard[position[0]][position[1]] === 3)
                    fightMonster();

                currentBoard[position[0]][position[1]] = 0;

                score--;

                updateMapUsingBoard(currentBoard);
            }
        }
        function moveLeft(){
            if(!isDead && position[1] > 0){
                currentBoard[position[0]][position[1]] = 2;
                position[1]--;
                if(position[0] === swordPosition[0] && position[1] === swordPosition[1]){
                    player.damage = 5.0;
                    swordPosition = [5, 5];
                    document.getElementById("sword-display").textContent = "You've got the sword!";
                }
                if(currentBoard[position[0]][position[1]] === 3)
                    fightMonster();

                currentBoard[position[0]][position[1]] = 0;

                score--;

                updateMapUsingBoard(currentBoard);
            }
        }
        function moveRight(){
            if(!isDead && position[1] < 4){
                currentBoard[position[0]][position[1]] = 2;
                position[1]++;
                if(position[0] === swordPosition[0] && position[1] === swordPosition[1]){
                    player.damage = 5.0;
                    swordPosition = [5, 5];
                    document.getElementById("sword-display").textContent = "You've got the sword!";
                }
                if(currentBoard[position[0]][position[1]] === 3)
                    fightMonster();

                currentBoard[position[0]][position[1]] = 0;

                score--;

                updateMapUsingBoard(currentBoard);
            }
        }
        const reset = () => {
            document.getElementsByClassName('move-buttons')[0].style.display = "";
            const battleContainer = document.getElementById("battle-container");
            if(battleContainer != null)
                battleContainer.remove();
            document.getElementById("sword-display").textContent = "";
            isDead = false;
            inBattle = false;

            createNewMap(boardTemplate);
        };

        const fightMonster = () => {
            // hide map display
            const mapDisplay = document.getElementById('map-container');
            mapDisplay.style.display = "none";

            enemy.health = 20;
            // create battle display
            const battleDisplay = document.createElement('div');
            battleDisplay.className = 'container';
            battleDisplay.id = 'battle-container';

            const battleSubDisplay = document.createElement('div');
            battleSubDisplay.className = 'row';
            battleDisplay.appendChild(battleSubDisplay);

            const fighters = [document.createElement('div'), document.createElement('div')];
            fighters[0].className = 'col';
            fighters[0].style.backgroundColor = "lightseagreen";
            fighters[0].style.height = "550px";
            fighters[0].innerHTML = "<h1>Player</h1><br /><p id='player-health'>HP: " + player.health
                + "</p><br /><br /><p id='player-updates'></p>";
            fighters[1].className = 'col';
            fighters[1].style.backgroundColor = "lightsalmon";
            fighters[1].style.height = "550px";
            fighters[1].innerHTML = "<h1>Enemy</h1><br /><p id='enemy-health'>HP: " + enemy.health
                + "</p><br /><br /><p id='enemy-updates'></p>";
            battleSubDisplay.append(fighters[0], fighters[1]);

            document.getElementsByTagName('body')[0].prepend(battleDisplay);
            
            inBattle = true;

            /*
            const playerDisplayData = [document.getElementById('player-health'), document.getElementById('player-updates')];
            const enemyDisplayData = [document.getElementById('enemy-health'), document.getElementById('enemy-updates')];
            do{
                playerDisplayData[0].textContent = player.health;
                enemyDisplayData[0].textContent = enemy.health;
            }while(player.health > 0 && enemy.health > 0)
            inBattle = false;
            */
        }

        function attack(){
            if(inBattle){
                const playerDisplayData = [document.getElementById('player-health'), document.getElementById('player-updates')];
                const enemyDisplayData = [document.getElementById('enemy-health'), document.getElementById('enemy-updates')];

                // player turn
                if(Math.round(Math.random())){
                    enemy.health -= player.damage;
                    playerDisplayData[1].innerHTML = "Hit the enemy for " + player.damage + " damage!";
                    enemyDisplayData[0].textContent = enemy.health;
                }
                else{
                    playerDisplayData[1].innerHTML = "Tried to hit the enemy but missed!";
                }

                // enemy turn
                if(enemy.health > 0){
                    enemyTurn(playerDisplayData[0], enemyDisplayData[1]);

                    // player died
                    if(player.health <= 0){
                        playerDisplayData[1].innerHTML += "<br /><br /><h3 style='color: red;'>You are dead!</h3>";
                        document.getElementsByClassName('move-buttons')[0].style.display = "none";
                        inBattle = false;
                        isDead = true;
                    }
                }
                else{ // enemy died
                    enemies--;
                    if(enemies < 1){
                        playerDisplayData[1].innerHTML += "<br /><br /><h3 style='color: blue;'>You beat the last enemy!!!<br />"
                            + "Your score: " + score + "</h3>";
                        
                        isDead = true; // not really, but this disables controls
                    }
                    else{
                        document.getElementById("battle-container").remove();
                        document.getElementById("map-container").style.display = "";
                    }
                    inBattle = false;
                }
            }
        }

        function heal(){
            if(inBattle){
                const playerDisplayData = [document.getElementById('player-health'), document.getElementById('player-updates')];
                const enemyDisplayData = [document.getElementById('enemy-health'), document.getElementById('enemy-updates')];

                // player turn
                const healAmount = Math.random() * 5;

                player.health += healAmount;
                playerDisplayData[1].innerHTML = "Healed for " + healAmount + " health!";
                playerDisplayData[0].textContent = player.health;

                // enemy turn
                enemyTurn(playerDisplayData[0], enemyDisplayData[1]);

                // player died
                if(player.health <= 0){
                    playerDisplayData[1].innerHTML += "<br /><br /><h3 style='color: red;'>You are dead!</h3>";
                    document.getElementsByClassName('move-buttons')[0].style.display = "none";
                    inBattle = false;
                }
                
            }
        }

        function enemyTurn(playerHealth, enemyUpdates) {
            if(Math.round(Math.random())){
                player.health -= enemy.damage;
                enemyUpdates.innerHTML = "Hit the player for " + enemy.damage + " damage!";
                playerHealth.textContent = player.health;
            }
            else{
                enemyUpdates.innerHTML = "Tried to hit the player but missed!";
            }
        }

    </script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
        src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script
        src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
  </body>
</html>